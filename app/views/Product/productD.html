<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chi ti·∫øt S·∫£n ph·∫©m</title>
  <link rel="stylesheet" href="/Css/Products/productd.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="container header-content">
      <h1>Burger House</h1>
      <nav>
        <ul>
          <li><a href="/">Trang ch·ªß</a></li>
          <li><a href="/api/cart/page" id="cart-link"style="display: none;">Gi·ªè H√†ng</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- HERO SECTION -->
  <section class="hero-section">
    <div class="container hero-content">
      <div class="hero-text">
        <h2>BURGER WEEK</h2>
        <p>Th∆∞·ªüng th·ª©c nh·ªØng chi·∫øc burger ngon nh·∫•t v·ªõi gi√° c·ª±c k·ª≥ h·∫•p d·∫´n!</p>
        <div class="hero-price-circle">
          <span>Ch·ªâ t·ª´<br />50.000 VND</span>
        </div>
      </div>
      <div class="hero-image">
        <img src="/image/foods/maplebaconburger.jpg" alt="Burger Image">
      </div>
    </div>
  </section>

  <!-- BREADCRUMB -->
  <div class="breadcrumb-container">
    <div class="container">
      <ul class="breadcrumb">
        <li><a href="/">Trang ch·ªß</a></li>
        <li>Chi ti·∫øt S·∫£n ph·∫©m</li>
      </ul>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <main class="container">
    <div id="product-detail-container">
      <!-- N·ªôi dung chi ti·∫øt s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã qua JavaScript -->
    </div>

    <!-- Ph·∫ßn g·ª£i √Ω c√°c s·∫£n ph·∫©m kh√°c -->
    <div class="related-products">
      <h3>C√°c s·∫£n ph·∫©m kh√°c</h3>
      <div class="items-grid">
        <!-- C√°c s·∫£n ph·∫©m g·ª£i √Ω s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y qua JavaScript -->
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="container">
      <p>&copy; 2025 Burger House. All rights reserved.</p>
    </div>
  </footer>
  <!-- SCRIPT -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const detailContainer = document.getElementById('product-detail-container');
      const relatedProductsContainer = document.querySelector('.items-grid');
      const productId = getProductIdFromPath();
      const cartLink = document.getElementById('cart-link');

      function checkUserRole() {
        axios.get('/auth/user')
          .then(response => {
            const user = response.data;
            if (user.role === 'customer') {
              cartLink.style.display = 'block';
            }
          })
        }
  
      console.log("Product ID:", productId);
      if (!productId) {
        detailContainer.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m.</p>';
        return;
      }
  
      axios.get(`/api/products/${productId}`)
        .then(response => {
          const product = response.data;
          if (!product || !product.food_id) {
            detailContainer.innerHTML = '<p>S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i.</p>';
            return;
          }
  
          const imageUrl = product.image_path || '/images/default.jpg';
          detailContainer.innerHTML = `
            <div class="product-detail">
              <div class="product-image">
                <img src="${imageUrl}" alt="${product.name}">
              </div>
              <div class="product-info">
                <h2 class="product-title">${product.name}</h2>
                <p class="price">${product.price} VND</p>
                <p class="stock">S·ªë l∆∞·ª£ng: ${product.stock}</p>
                <p class="description">${product.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                <label for="quantity">S·ªë l∆∞·ª£ng:</label>
                <input type="number" id="quantity" value="1" min="1">
                <button class="btn-add-to-cart">Th√™m v√†o gi·ªè</button>
                <p id="cart-message"></p>
              </div>
            </div>
          `;
  
          document.querySelector('.btn-add-to-cart').addEventListener('click', function() {
            addToCart(product.food_id);
          });
  
          fetchRandomRecommendedProducts();
        })
        .catch(error => {
          console.error('L·ªói khi t·∫£i chi ti·∫øt s·∫£n ph·∫©m:', error);
          detailContainer.innerHTML = '<p>ƒê√£ x·∫£y ra l·ªói khi t·∫£i th√¥ng tin s·∫£n ph·∫©m.</p>';
        });
  
        function addToCart(foodId) {
          const token = getCookie("token");

          if (!token) {
              showMessage("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!", "red");
              window.location.href = "/auth/login";
              return;
          }

          const quantity = parseInt(document.getElementById("quantity").value);
          if (isNaN(quantity) || quantity < 1) {
              showMessage("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!", "red");
              return;
          }

          // Ki·ªÉm tra xem s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
          axios.get("/api/cart", { headers: { Authorization: `Bearer ${token}` } })
              .then(response => {
                  const cartItems = response.data;
                  const existingItem = cartItems.find(item => item.food_id === foodId);

                  if (existingItem) {
                      // N·∫øu s·∫£n ph·∫©m ƒë√£ c√≥, tƒÉng s·ªë l∆∞·ª£ng
                      const newQuantity = existingItem.quantity + quantity;

                      axios.put(`/api/cart/${existingItem.cart_item_id}`, { quantity: newQuantity }, {
                          headers: { Authorization: `Bearer ${token}` }
                      })
                      .then(() => {
                          showMessage("ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè h√†ng!", "green");
                      })
                      .catch(error => {
                          console.error("L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:", error);
                          showMessage("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi·ªè h√†ng!", "red");
                      });

                  } else {
                      // N·∫øu s·∫£n ph·∫©m ch∆∞a c√≥, th√™m m·ªõi
                      axios.post('/api/cart/', { food_id: foodId, quantity }, {
                          headers: { Authorization: `Bearer ${token}` }
                      })
                      .then(() => {
                          showMessage("ƒê√£ th√™m v√†o gi·ªè h√†ng!", "green");
                      })
                      .catch(error => {
                          console.error("L·ªói khi th√™m v√†o gi·ªè h√†ng:", error);
                          showMessage("Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng!", "red");
                      });
                  }
              })
              .catch(error => {
                  console.error("L·ªói khi ki·ªÉm tra gi·ªè h√†ng:", error);
                  showMessage("Kh√¥ng th·ªÉ ki·ªÉm tra gi·ªè h√†ng!", "red");
              });
      } 
              
      function fetchRandomRecommendedProducts() {
        axios.get(`/api/products/`)
          .then(response => {
            let products = response.data;
            if (!products || products.length === 0) {
              relatedProductsContainer.innerHTML = '<p>Kh√¥ng c√≥ s·∫£n ph·∫©m g·ª£i √Ω.</p>';
              return;
            }
  
            // üîÄ Tr·ªôn ng·∫´u nhi√™n danh s√°ch s·∫£n ph·∫©m
            products = shuffleArray(products).slice(0, 4); // L·∫•y 4 s·∫£n ph·∫©m ng·∫´u nhi√™n
  
            relatedProductsContainer.innerHTML = products.map(product => `
              <div class="product-item">
                <img src="${product.image_path || '/images/default.jpg'}" alt="${product.name}">
                <h4>${product.name}</h4>
                <p>${product.price} VND</p>
                <a href="/api/products/Page/${product.food_id}" class="btn btn-sm btn-danger">Xem</a>
              </div>
            `).join('');
          })
          .catch(error => {
            console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m g·ª£i √Ω:", error);
            relatedProductsContainer.innerHTML = '<p>Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m g·ª£i √Ω.</p>';
          });
      }
  
      // üé≤ H√†m tr·ªôn m·∫£ng ng·∫´u nhi√™n (Fisher-Yates Shuffle)
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
  
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }
  
      function showMessage(message, color) {
        const messageElement = document.getElementById("cart-message");
        messageElement.innerText = message;
        messageElement.style.color = color;
      }
  
      function getProductIdFromPath() {
        const pathParts = window.location.pathname.split('/');
        const id = pathParts[pathParts.length - 1];
        return isNaN(id) ? null : id;
      }

      checkUserRole();
    });
  </script> 
</body>
</html>
